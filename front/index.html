<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8" />
<title>不怎么好用的拍卖查询</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
  :root{
    --brand:#0078d7;
    --bg:#f7f8fa;
    --text:#333;
    --muted:#777;
    --border:#e6e6e6;
    --card:#fff;
    --hl-red:#d0021b;
    --hl-green:#1d9e51;
  }
  body { font-family: "Microsoft YaHei", system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; background:var(--bg); margin:20px; color:var(--text); }

  .layout{ max-width: 1160px; margin: 0 auto; display:flex; gap:16px; align-items:flex-start; }
  .left{ flex: 1 1 68%; display:flex; flex-direction:column; gap:14px; }
  .right{ flex: 0 0 360px; }
  @media (max-width: 980px){ .layout{ flex-direction:column; } .right{ flex: 1 1 auto; } }

  .card {
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 16px 20px;
  box-shadow: 0 2px 8px rgba(0,0,0,.05);
  position: relative;
  margin-top: 20px;   /* ← 新增：每个卡片上方留空 */
}
  .title { font-size:16px; font-weight:800; margin-bottom:6px; }
  .line { margin:5px 0; color:#555; }
  .line-strong {
  display: flex;
  justify-content: space-between; /* 左右两端对齐 */
  align-items: center;
  font-weight: 800;
  color: #000;
  width: 100%;
  }
  .line-strong .right {
    margin-left: auto;   /* 确保右边靠最右 */
    text-align: right;
  }
  /*历史信息组*/
  .group {
  font-family: "Microsoft YaHei", sans-serif;   /* ✅ 改成雅黑字体 */
  background: rgba(249, 249, 249, 0.8);         /* ✅ 半透明浅灰底色 */
  border-left: 3px solid var(--brand);
  padding: 10px 14px;
  border-radius: 8px;
  margin-top: 18px;
  font-weight: 600;
  box-shadow: 0 1px 4px rgba(0,0,0,0.05);       /* ✅ 轻微阴影增强层次 */
}
  .item { margin-left:15px; white-space:pre-wrap; line-height:1.7; }
  .center-muted { text-align:center; color:#999; }
  .err { text-align:center; color:#c0392b; margin-top:8px; }
  .nick { color:#0f61a8; font-weight:800; }

  .meta-box{ background:#ffffffeb; border:1px solid #ddd; border-radius:12px; padding:14px 16px; font-size:14px; line-height:1.6; box-shadow:0 6px 16px rgba(0,0,0,.10); position: sticky; top: 16px; }
  .meta-box .label { color:#666; display:inline-block; width:72px; vertical-align: top; }
  .meta-box .value { color:#111; font-weight:800; }
  .meta-box .value-block { color:#111; font-weight:600; white-space: pre-wrap; word-break: break-word; display: inline; }

  .hl-red{ color:var(--hl-red); font-weight:800; }
  .hl-green{ color:var(--hl-green); font-weight:800; }
  .subtle { color:var(--muted); font-size:12px; margin-top:4px; }

  .records-visible{}
  .records-more{ display:none; }
  .card:hover .records-more{ display:block; }

  .fold-tip{
    color:var(--muted);
    font-size:12px;
    text-align:center;
    margin-top:6px;
  }
  .card:hover .fold-tip{ display:none; }
</style>
</head>
<body>
  <div class="layout">
    <div class="left">
      <div id="list"></div>
      <div id="error" class="err"></div>
    </div>

    <aside class="right">
      <div class="meta-box" id="fixedMeta">
        <div><span class="label">鸽子ID：</span><span class="value" id="m_id">-</span></div>
        <div><span class="label">环号：</span><span class="value" id="m_ring">-</span></div>
        <div><span class="label">鸽主：</span><span class="value" id="m_matcher">-</span></div>
        <div><span class="label">内容：</span><span class="value-block" id="m_content">-</span></div>
      </div>
    </aside>
  </div>

<script>
(() => {
  const SSE_URL = "http://localhost:8001/sse/pigeon";

  const list = document.getElementById("list");
  const errorBox = document.getElementById("error");
  const mId = document.getElementById("m_id");
  const mRing = document.getElementById("m_ring");
  const mMatcher = document.getElementById("m_matcher");
  const mContent = document.getElementById("m_content");

  const showError = msg => errorBox.textContent = msg || "";
  const safe = v => (v===0 ? 0 : (v ?? "-"));
  const groupBy = (arr, keyFn) => { const m=new Map(); (arr||[]).forEach(r=>{ const k=keyFn(r); if(!m.has(k)) m.set(k,[]); m.get(k).push(r); }); return m; };
  const displayQuote = v => (v==null ? "-" : (typeof v === "object" ? (()=>{ try{return JSON.stringify(v);}catch{return "-";} })() : String(v)));
  const toChars = s => Array.from((s ?? "").toString());
  function fmtMoney(v){ const n = Number(v); return Number.isFinite(n) ? n.toLocaleString("zh-CN") : displayQuote(v); }

  function highlightWithSet(str, set, cls){
    const out = toChars(str).map(ch => set.has(ch) ? `<span class="${cls}">${ch}</span>` : ch).join("");
    return out || "-";
  }

  function pickItems(payload) { return Array.isArray(payload?.items) ? payload.items : Array.isArray(payload) ? payload : []; }
  function pickCurrent(payload) { return payload?.current_id ?? null; }

  function renderCurrentMeta(current) {
    mId.textContent = safe(current?.id);
    mRing.textContent = safe(current?.footring ?? current?.foot_ring ?? current?.ring);
    const matcherName = current?.matchername ?? current?.matcher_name ?? current?.matcher;
    mMatcher.textContent = safe(matcherName);

    const contentVal = current?.content ?? current?.xlsx_content ?? current?.desc ?? current?.description;
    mContent.textContent = (contentVal == null ? "-" : (typeof contentVal === "object" ? JSON.stringify(contentVal) : String(contentVal)));
  }

  function render(payload) {
    const current = pickCurrent(payload) || {};
    const currentMatcherName = (current?.matchername ?? current?.matcher_name ?? "").toString();
    const currentSet = new Set(toChars(currentMatcherName));

    renderCurrentMeta(current);

    list.innerHTML = "";
    const items = pickItems(payload);
    if (!items.length) { list.innerHTML = `<div class="center-muted">暂无数据</div>`; return; }

    items.forEach(item => {
      const userNickname = (item.user_nickname ?? "").toString();
      const userCode = item.user_code ?? "";
      const count = item.count;
      const results = item.results || {};
      let historyRows = Array.isArray(results[userCode]) ? results[userCode] : null;
      if (!historyRows || !historyRows.length) {
        for (const v of Object.values(results)) { if (Array.isArray(v) && v.length) { historyRows = v; break; } }
      }
      historyRows = historyRows || [];

      const card = document.createElement("div");
      card.className = "card";

      const title = document.createElement("div");
      title.className = "title";
      const greenNick = highlightWithSet(userNickname, currentSet, 'hl-green');
      title.innerHTML = `出价人：<span class="nick">${greenNick}</span>`;
      card.appendChild(title);

      const base2 = document.createElement("div");
      base2.className = "line line-strong";
      base2.textContent = `当前出价：¥${fmtMoney(item.quote)} `;
      card.appendChild(base2);

      const base = document.createElement("div");
      base.className = "line line-strong";
      base.innerHTML = `
        <span>出价id：${safe(userCode)}</span>
        <span class="right">出价次数：${safe(count)}</span>
        `;
      card.appendChild(base);

      const groups = groupBy(historyRows, r => (r?.matcher_name ?? "-").toString().trim());
      if (groups.size === 0) {
        const none = document.createElement("div");
        none.className = "center-muted";
        none.textContent = "历史拍得记录：暂无";
        card.appendChild(none);
      } else {
        const MAX_GROUPS = 3;
        const visibleWrap = document.createElement('div');
        visibleWrap.className = 'records-visible';
        const moreWrap = document.createElement('div');
        moreWrap.className = 'records-more';

        let idxGroup = 0;
        groups.forEach((arr, matcherNameRaw) => {
          const matcherName = matcherNameRaw || "-";
          const group = document.createElement("div");
          group.className = "group";
          const aggCount = Number(arr[0]?._agg_count ?? arr.length) || arr.length;
          let sim = Number(arr[0]?._match_score ?? 0);
          sim = (sim * 100).toFixed(2);
          const redMatcher = highlightWithSet(matcherName, currentSet, 'hl-red');
          group.innerHTML = `历史拍得记录：${redMatcher}（相似度：${sim}%） | 成交次数：${aggCount}`;

          // 先放入首条鸽子行到组内
          const first = arr[0];
          const line = document.createElement("div");
          line.className = "item";
          const name = safe(first?.name);
          const ring = safe(first?.foot_ring ?? first?.footring);
          const price = displayQuote(first?.quote);
          line.textContent = `└─ 鸽子：${name} 环号：${ring}  价格：${price}`;
          group.appendChild(line);

          // （可选）把本组剩余记录也一并放入组内
          for (let i = 1; i < arr.length; i++) {
            const r = arr[i];
            const extra = document.createElement("div");
            extra.className = "item";
            const n2 = safe(r?.name);
            const r2 = safe(r?.foot_ring ?? r?.footring);
            const p2 = displayQuote(r?.quote);
            extra.textContent = `└─ 鸽子：${n2} 环号：${r2}  价格：${p2}`;
            group.appendChild(extra);
          }

          // 把“整组”丢到对应的 bucket（visible 或 more）
          const bucket = (idxGroup < MAX_GROUPS) ? visibleWrap : moreWrap;
          bucket.appendChild(group);
          idxGroup++;
        });

        card.appendChild(visibleWrap);
        if (moreWrap.childElementCount > 0){
          card.appendChild(moreWrap);
          const tip = document.createElement('div');
          tip.className = 'fold-tip';
          tip.textContent = `已折叠 ${groups.size - MAX_GROUPS} 条历史记录，鼠标移上展开 ↓`;
          card.appendChild(tip);
        }
      }

      list.appendChild(card);
    });
  }

  function connect(){
    const es = new EventSource(SSE_URL);
    es.onopen = () => { showError(""); };
    es.onerror = () => {};
    es.addEventListener("bids", (ev) => {
      try { const data = JSON.parse(ev.data); render(data); showError(""); }
      catch (err) { showError("数据解析错误：" + (err?.message || err)); }
    });
    es.onmessage = (ev) => {
      if (!ev?.data) return;
      try { const data = JSON.parse(ev.data); render(data); showError(""); } catch {}
    };
  }
  connect();
})();
</script>
</body>
</html>