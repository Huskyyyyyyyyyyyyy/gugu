<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8"/>
  <title>é¸½æ‹å®æ—¶æ•°æ®ï¼ˆåˆ†ç»„å±•ç¤ºï¼‰</title>
  <style>
    body { font-family: "Microsoft YaHei", sans-serif; background:#f7f8fa; margin: 20px; color:#333;}
    h1 { text-align:center; color:#0078d7; margin-bottom:8px;}
    #status { text-align:center; font-size:14px; margin-bottom:16px;}
    #list { max-width:720px; margin:0 auto; display:flex; flex-direction:column; gap:14px; }
    .card { background:#fff; border:1px solid #ddd; border-radius:10px; padding:16px 18px; box-shadow:0 2px 6px rgba(0,0,0,.05); }
    .title { font-size:16px; font-weight:700; margin-bottom:6px;}
    .line { margin:6px 0; }
    .group { background:#f9f9f9; border-left:3px solid #0078d7; padding:8px 12px; border-radius:6px; margin-top:8px;}
    .item { margin-left:14px; white-space:pre-wrap; line-height:1.6; }
    .muted { color:#777; }
    .strong { font-weight:700; color:#111; }
    .nick { color:#0f61a8; font-weight:700; }
    .err { text-align:center; color:#c0392b; margin-top:8px; }
    .center-muted { text-align:center; color:#999; }
  </style>
</head>
<body>
  <h1>ğŸ¦ é¸½æ‹å®æ—¶æ•°æ®</h1>
  <div id="status">è¿æ¥çŠ¶æ€ï¼š<span id="statusText">æœªè¿æ¥</span></div>
  <div id="list"></div>
  <div id="error" class="err"></div>

<script>
(() => {
  // === é…ç½®ï¼šä¿®æ”¹ä¸ºä½ çš„ SSE åœ°å€ ===
  const SSE_URL = "http://localhost:8001/sse/pigeon"; // å¦‚ç”¨ 8000 å°±æ”¹æˆ 8000

  const statusText = document.getElementById("statusText");
  const list = document.getElementById("list");
  const errorBox = document.getElementById("error");

  function setStatus(ok) {
    statusText.textContent = ok ? "å·²è¿æ¥" : "æ–­å¼€ï¼Œæ­£åœ¨é‡è¿...";
    statusText.style.color = ok ? "green" : "red";
  }
  function showError(msg) { errorBox.textContent = msg || ""; }

  function toPercent(score) {
    const n = Number(score);
    if (isNaN(n)) return "";
    return `${Math.round(n * 100)}%`;
  }
  function safe(s){ return (s===0?0:(s||"-")); }

  // å°† history æŒ‰ matcher_name åˆ†ç»„
  function groupByMatcher(rows) {
    const map = new Map();
    (rows || []).forEach(r => {
      const key = (r?.matcher_name || "-").trim();
      if (!map.has(key)) map.set(key, []);
      map.get(key).push(r);
    });
    return map;
  }

  function render(payload) {
    list.innerHTML = "";
    if (!payload?.items?.length) {
      list.innerHTML = `<div class="center-muted">æš‚æ— æ•°æ®</div>`;
      return;
    }
    payload.items.forEach(item => {
      const card = document.createElement("div");
      card.className = "card";

      // å¤´éƒ¨ï¼šå‡ºä»·äºº
      const title = document.createElement("div");
      title.className = "title";
      title.innerHTML = `å‡ºä»·äººï¼š<span class="nick">${safe(item.userNickname)}</span>`;
      card.appendChild(title);

      // åŸºæœ¬ä¿¡æ¯ï¼ˆå¯æŒ‰éœ€ä¿ç•™ï¼‰
      const base = document.createElement("div");
      base.className = "line muted";
      base.textContent = `å‡ºä»·äººç¼–å·ï¼š${safe(item.userCode)}    å‡ºä»·æ¬¡æ•°ï¼š${safe(item.count)}`;
      card.appendChild(base);

      // å†å²è®°å½•åˆ†ç»„
      const rows = Array.isArray(item.history) ? item.history : [];
      const groups = groupByMatcher(rows);

      if (groups.size === 0) {
        const none = document.createElement("div");
        none.className = "center-muted";
        none.textContent = "å†å²æ‹å¾—è®°å½•ï¼šæš‚æ— ";
        card.appendChild(none);
      } else {
        groups.forEach((arr, matcherName) => {
          // ç»„å¤´ï¼šå†å²æ‹å¾—è®°å½•: æå›› | æˆäº¤æ¬¡æ•°: X
          // æˆäº¤æ¬¡æ•°ä¼˜å…ˆä½¿ç”¨è¡Œä¸Šçš„ _agg_countï¼Œå¦åˆ™ç”¨ç»„å†…æ¡ç›®æ•°
          const aggCount = Number(arr[0]?._agg_count ?? arr.length) || arr.length;
          const head = document.createElement("div");
          head.className = "group";
          head.innerHTML = `å†å²æ‹å¾—è®°å½•ï¼š<span class="strong">${matcherName}</span> | æˆäº¤æ¬¡æ•°ï¼š<span class="strong">${aggCount}</span>`;
          card.appendChild(head);

          // ç»„å†…é€æ¡ï¼š â””â”€ é¸½å­ï¼š{name}ï¼ˆç›¸ä¼¼åº¦ï¼šYY%ï¼‰ ç¯å·ï¼š{foot_ring} ä»·æ ¼ï¼š{quote}
          arr.forEach(r => {
            const line = document.createElement("div");
            line.className = "item";
            const name = safe(r?.name);
            const ring = safe(r?.foot_ring);
            const price = safe(r?.quote);
            const sim = toPercent(r?._match_score);
            const simPart = sim ? `ï¼ˆç›¸ä¼¼åº¦ï¼š${sim}ï¼‰` : "";
            line.textContent = `â””â”€ é¸½å­ï¼š${name}${simPart}  ç¯å·ï¼š${ring}  ä»·æ ¼ï¼š${price}`;
            card.appendChild(line);
          });
        });
      }

      list.appendChild(card);
    });
  }

  function connect() {
    const es = new EventSource(SSE_URL);

    es.onopen = () => { setStatus(true); showError(""); };
    es.onerror = () => { setStatus(false); };

    es.addEventListener("bids", (ev) => {
      try {
        const data = JSON.parse(ev.data);
        render(data);
        showError("");
      } catch (err) {
        showError("æ•°æ®è§£æé”™è¯¯ï¼š" + (err?.message || err));
      }
    });

    es.addEventListener("error", (ev) => {
      try {
        if (typeof ev.data === "string" && ev.data.trim()) {
          try {
            const data = JSON.parse(ev.data);
            showError("æœåŠ¡ç«¯é”™è¯¯ï¼š" + (data?.error?.message || ev.data));
          } catch {
            showError(ev.data); // é JSON çš„é”™è¯¯æ–‡æœ¬ï¼ŒåŸæ ·æ˜¾ç¤º
          }
        } else {
          showError("æœåŠ¡ç«¯é”™è¯¯æˆ–è¿æ¥ä¸­æ–­ï¼Œæµè§ˆå™¨ä¼šè‡ªåŠ¨é‡è¿â€¦");
        }
      } catch {
        showError("æœåŠ¡ç«¯é”™è¯¯ï¼ˆæ— å¯è¯»æ•°æ®ï¼‰");
      }
    });
  }

  connect();
})();
</script>
</body>
</html>
