<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8" />
<title>é¸½æ‹å®æ—¶æ•°æ®</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
  body { font-family: "Microsoft YaHei", system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; background:#f7f8fa; margin:20px; color:#333; }
  /* h1ã€çŠ¶æ€æ å¯æŒ‰éœ€æ¢å¤ */
  /* h1 { text-align:center; color:#0078d7; margin-bottom:8px; font-weight:800; } */
  /* #status { text-align:center; margin-bottom:14px; font-size:14px; } */
  #list { max-width:860px; margin:0 auto; display:flex; flex-direction:column; gap:14px; }
  .card { background:#fff; border:1px solid #e6e6e6; border-radius:12px; padding:16px 20px; box-shadow:0 2px 8px rgba(0,0,0,.05); }
  .title { font-size:16px; font-weight:800; margin-bottom:6px; }
  .line { margin:5px 0; color:#555; }
  .group { background:#f9f9f9; border-left:3px solid #0078d7; padding:8px 12px; border-radius:6px; margin-top:10px; font-weight:600; }
  .item { margin-left:15px; white-space:pre-wrap; line-height:1.7; }
  .center-muted { text-align:center; color:#999; }
  .err { text-align:center; color:#c0392b; margin-top:8px; }
  .nick { color:#0f61a8; font-weight:800; }

  /* å³ä¸Šè§’å›ºå®šä¿¡æ¯æ¡†ï¼ˆæ˜¾ç¤º current_idï¼‰ */
  .fixed-meta {
    position: fixed; top: 16px; right: 16px; z-index: 9999;
    background: #ffffffeb; backdrop-filter: blur(4px);
    border: 1px solid #ddd; border-radius: 12px; padding: 10px 12px;
    font-size: 13px; line-height: 1.5; box-shadow: 0 4px 12px rgba(0,0,0,.08);
    min-width: 260px; text-align: left;
  }
  .fixed-meta .label { color:#666; display:inline-block; width:70px; }
  .fixed-meta .value { color:#111; font-weight:800; }

  /* ç›¸åŒå­—ç¬¦é«˜äº® & å¯¹æ¯”è¯´æ˜ */
  .hl { color:#d0021b; font-weight:800; }
  .subtle { color:#777; font-size:12px; margin-top:4px; }
</style>
</head>
<body>
  <div class="fixed-meta" id="fixedMeta">
    <div><span class="label">é¸½å­IDï¼š</span><span class="value" id="m_id">-</span></div>
    <div><span class="label">ç¯å·ï¼š</span><span class="value" id="m_ring">-</span></div>
    <div><span class="label">é¸½ä¸»ï¼š</span><span class="value" id="m_matcher">-</span></div>
  </div>

  <!-- å¦‚éœ€æ˜¾ç¤ºæ ‡é¢˜/è¿æ¥çŠ¶æ€ï¼Œå–æ¶ˆæ³¨é‡Šå³å¯ -->
  <!-- <h1>ğŸ¦ é¸½æ‹å®æ—¶æ•°æ®</h1>
  <div id="status">è¿æ¥çŠ¶æ€ï¼š<span id="statusText">æœªè¿æ¥</span></div> -->

  <div id="list"></div>
  <div id="error" class="err"></div>

<script>
(() => {
  // === ä¿®æ”¹ä¸ºä½ çš„ SSE åœ°å€ï¼ˆsnake_case åç«¯ï¼‰ ===
  const SSE_URL = "http://localhost:8001/sse/pigeon";

  // DOM
  const statusText = document.getElementById("statusText"); // å¯èƒ½ä¸å­˜åœ¨
  const list = document.getElementById("list");
  const errorBox = document.getElementById("error");
  const mId = document.getElementById("m_id");
  const mRing = document.getElementById("m_ring");
  const mMatcher = document.getElementById("m_matcher");

  // ====== å·¥å…·å‡½æ•° ======
  const setStatus = ok => {
    if (!statusText) return; // éšè—çŠ¶æ€æ æ—¶æ— æ“ä½œ
    statusText.textContent = ok ? "å·²è¿æ¥" : "æ–­å¼€ï¼Œæ­£åœ¨é‡è¿...";
    statusText.style.color = ok ? "green":"red";
  };
  const showError = msg => errorBox.textContent = msg || "";
  const safe = v => (v===0 ? 0 : (v ?? "-"));
  const groupBy = (arr, keyFn) => {
    const m=new Map(); (arr||[]).forEach(r=>{ const k=keyFn(r); if(!m.has(k)) m.set(k,[]); m.get(k).push(r); }); return m;
  };
  const displayQuote = v => (v==null ? "-" : (typeof v === "object" ? (()=>{ try{return JSON.stringify(v);}catch{return "-";} })() : String(v)));
  function fmtMoney(v) {
    const n = Number(v);
    if (Number.isFinite(n)) return n.toLocaleString("zh-CN");
    return displayQuote(v);
  }

  // ç›¸ä¼¼åº¦ & é«˜äº®ï¼ˆæŒ‰â€œå­—ç¬¦â€ï¼‰
  const toChars = s => Array.from((s ?? "").toString());
  function charJaccardPercent(a, b) {
    const A = new Set(toChars(a)), B = new Set(toChars(b));
    if (!A.size && !B.size) return 0;
    let inter = 0; A.forEach(ch => { if (B.has(ch)) inter++; });
    const union = new Set([...A, ...B]).size || 1;
    return Math.round((inter / union) * 100);
  }
  function commonCharsAtLeastTwo(a, b, c) {
    const cnt = new Map();
    [a, b, c].forEach(s => { const seen = new Set(toChars(s)); seen.forEach(ch => cnt.set(ch, (cnt.get(ch)||0)+1)); });
    const commons = new Set(); cnt.forEach((n, ch) => { if (n >= 2) commons.add(ch); });
    return commons;
  }
  function highlightCommonChars(str, commons) {
    return toChars(str).map(ch => commons.has(ch) ? `<span class="hl">${ch}</span>` : ch).join("");
  }

  // ä»… snake_caseï¼šåç«¯å·²ç»Ÿä¸€
  function pickItems(payload) { return Array.isArray(payload?.items) ? payload.items : Array.isArray(payload) ? payload : []; }
  function pickCurrent(payload) { return payload?.current_id ?? null; }

  // å³ä¸Šè§’ meta
  function renderCurrentMeta(current) {
    mId.textContent = safe(current?.id);
    mRing.textContent = safe(current?.footring ?? current?.foot_ring ?? current?.ring);
    mMatcher.textContent = safe(current?.matchername ?? current?.matcher_name ?? current?.matcher);
  }

  // ====== ä¸»æ¸²æŸ“ ======
  function render(payload) {
    const current = pickCurrent(payload);
    const currentMatcherName = (current?.matchername ?? current?.matcher_name ?? "").toString();
    renderCurrentMeta(current);

    list.innerHTML = "";
    const items = pickItems(payload);
    if (!items.length) {
      list.innerHTML = `<div class="center-muted">æš‚æ— æ•°æ®</div>`;
      return;
    }

    items.forEach(item => {
      const userNickname = item.user_nickname ?? "";
      const userCode = item.user_code ?? "";
      const count = item.count;
      const results = item.results || {};
      // ä» results ä¸­å–å†…å±‚å†å²ï¼šä¼˜å…ˆ user_codeï¼Œå…œåº•å–ç¬¬ä¸€ä¸ªéç©ºæ•°ç»„
      let historyRows = Array.isArray(results[userCode]) ? results[userCode] : null;
      if (!historyRows || !historyRows.length) {
        for (const v of Object.values(results)) { if (Array.isArray(v) && v.length) { historyRows = v; break; } }
      }
      historyRows = historyRows || [];

      const card = document.createElement("div");
      card.className = "card";

      // å‡ºä»·äºº
      const title = document.createElement("div");
      title.className = "title";
      title.innerHTML = `å‡ºä»·äººï¼š<span class="nick">${safe(userNickname)}</span>`;
      card.appendChild(title);

      // å½“å‰å‡ºä»·
      const base2 = document.createElement("div");
      base2.className = "line";
      base2.textContent = `å½“å‰å‡ºä»·ï¼šÂ¥${fmtMoney(item.quote)} `;
      card.appendChild(base2);

      // åŸºæœ¬ä¿¡æ¯
      const base = document.createElement("div");
      base.className = "line";
      base.textContent = `å‡ºä»·ç¼–å·ï¼š${safe(userCode)}    å‡ºä»·æ¬¡æ•°ï¼š${safe(count)}`;
      card.appendChild(base);

      // åˆ†ç»„ï¼šæŒ‰ matcher_name
      const groups = groupBy(historyRows, r => (r?.matcher_name ?? "-").toString().trim());
      if (groups.size === 0) {
        const none = document.createElement("div");
        none.className = "center-muted";
        none.textContent = "å†å²æ‹å¾—è®°å½•ï¼šæš‚æ— ";
        card.appendChild(none);
      } else {
        groups.forEach((arr, matcherName) => {
          const group = document.createElement("div");
          group.className = "group";
          const aggCount = Number(arr[0]?._agg_count ?? arr.length) || arr.length;

          // ç›¸ä¼¼åº¦ï¼šmatcher_name vs å½“å‰æ‹å“é¸½ä¸»
          const sim = charJaccardPercent(matcherName, currentMatcherName);
          // å…±åŒå­—ç¬¦ï¼šå‡ºä»·äººæ˜µç§°ã€å†å²é¸½ä¸»ã€å½“å‰é¸½ä¸» ä¸‰è€…ä¸­è‡³å°‘ä¸¤è€…åŒ…å«
          const commons = commonCharsAtLeastTwo(matcherName, currentMatcherName, userNickname);
          const hlMatcher = highlightCommonChars(matcherName, commons);
          const hlCurrent = highlightCommonChars(currentMatcherName, commons);
          const hlBidder = highlightCommonChars(userNickname, commons);

          group.innerHTML = `å†å²æ‹å¾—è®°å½•ï¼š${hlMatcher}ï¼ˆç›¸ä¼¼åº¦ï¼š${sim}%ï¼‰ | æˆäº¤æ¬¡æ•°ï¼š${aggCount}`
                            + `<div class="subtle">å¯¹æ¯”ï¼šå½“å‰é¸½ä¸»ï¼š${hlCurrent}ã€€|ã€€å‡ºä»·äººæ˜µç§°ï¼š${hlBidder}</div>`;
          card.appendChild(group);

          // é€æ¡è®°å½•
          arr.forEach(r => {
            const line = document.createElement("div");
            line.className = "item";
            const name = safe(r?.name);
            const ring = safe(r?.foot_ring ?? r?.footring);
            const price = displayQuote(r?.quote);
            line.textContent = `â””â”€ é¸½å­ï¼š${name} ç¯å·ï¼š${ring}  ä»·æ ¼ï¼š${price}`;
            card.appendChild(line);
          });
        });
      }

      list.appendChild(card);
    });
  }

  // ====== è¿æ¥ SSE ======
  function connect() {
    const es = new EventSource(SSE_URL);
    es.onopen = () => { setStatus(true); showError(""); };
    es.onerror = () => { setStatus(false); };

    // å…·åäº‹ä»¶ï¼šbids
    es.addEventListener("bids", (ev) => {
      try {
        const data = JSON.parse(ev.data);
        render(data);
        showError("");
      } catch (err) {
        showError("æ•°æ®è§£æé”™è¯¯ï¼š" + (err?.message || err));
      }
    });

    // å…œåº•ï¼šé»˜è®¤æ¶ˆæ¯
    es.onmessage = (ev) => {
      if (!ev?.data) return;
      try {
        const data = JSON.parse(ev.data);
        render(data);
        showError("");
      } catch { /* é JSON å¿½ç•¥ */ }
    };

    // æœåŠ¡å™¨é”™è¯¯äº‹ä»¶ï¼ˆå¯é€‰ï¼‰
    es.addEventListener("error", (ev) => {
      try {
        if (typeof ev.data === "string" && ev.data.trim()) {
          try {
            const d = JSON.parse(ev.data);
            showError("æœåŠ¡ç«¯é”™è¯¯ï¼š" + (d?.error?.message || ev.data));
          } catch { showError(ev.data); }
        } else {
          showError("æœåŠ¡ç«¯é”™è¯¯æˆ–æ–­å¼€ï¼Œæµè§ˆå™¨ä¼šè‡ªåŠ¨é‡è¿â€¦");
        }
      } catch {
        showError("æœåŠ¡ç«¯é”™è¯¯ï¼ˆæ— å¯è¯»æ•°æ®ï¼‰");
      }
    });
  }

  connect();
})();
</script>
</body>
</html>
