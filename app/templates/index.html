<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <title>鸽子拍卖实时系统 - Vue + Element Plus</title>
  <!-- 引入 Element Plus 样式 -->
  <link rel="stylesheet" href="https://unpkg.com/element-plus/dist/index.css" />
  <!-- Vue 3 + Element Plus CDN -->
  <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
  <script src="https://unpkg.com/element-plus"></script>
  <!-- 样式 -->
  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
    }
    .container {
      display: flex;
      height: 100vh;
    }
    .left-pane {
      flex: 1;
      border-right: 1px solid #ccc;
    }
    .right-pane {
      flex: 1;
      padding: 20px;
      overflow-y: auto;
    }
    h2 {
      margin-bottom: 20px;
    }
  </style>
</head>
<body>
  <div id="app" class="container">
    <!-- 左侧：嵌入鸽子拍卖网站 -->
    <div class="left-pane">
      <iframe src="https://cdn.guguxinge.com/jingjia/#/home" width="100%" height="100%" frameborder="0"></iframe>
    </div>

    <!-- 右侧：拍卖实时数据展示 -->
    <div class="right-pane">
      <h2>拍卖实时数据</h2>
      <el-table :data="dataList" border stripe style="width: 100%">
        <el-table-column prop="foot_ring" label="环号" width="120" />
        <el-table-column prop="feather_color" label="羽色" width="100" />
        <el-table-column prop="matcher_name" label="匹配人" width="120" />
        <el-table-column prop="start_price" label="起拍价" width="100" />
        <el-table-column prop="bid_count" label="出价次数" width="100" />
        <el-table-column prop="bid_time" label="最新出价时间" width="180" />
        <el-table-column prop="status_name" label="状态" />
      </el-table>
    </div>
  </div>

  <!-- Vue 脚本 -->
  <script>
    const { createApp, ref, onMounted } = Vue;

    createApp({
      setup() {
        const dataList = ref([]);

        // 建立 WebSocket 连接
        const connectWebSocket = () => {
          const ws = new WebSocket("ws://127.0.0.1:8000/ws/data");

          ws.onopen = () => {
            console.log("✅ WebSocket 已连接");
          };

          ws.onmessage = (event) => {
            try {
              const msg = JSON.parse(event.data);
              if (Array.isArray(msg.data)) {
                dataList.value = [...msg.data];
              } else {
                console.warn("⚠️ 数据格式错误:", msg);
              }
            } catch (e) {
              console.error("❌ 解析消息失败:", e);
            }
          };

          ws.onerror = (err) => {
            console.error("❌ WebSocket 错误:", err);
          };

          ws.onclose = () => {
            console.warn("⚠️ WebSocket 已关闭，5秒后重连...");
            setTimeout(connectWebSocket, 5000); // 自动重连
          };
        };

        onMounted(() => {
          connectWebSocket();
        });

        return {
          dataList,
        };
      },
    }).use(ElementPlus).mount("#app");
  </script>
</body>
</html>
